@using ITVisions.Blazor.Controls
@using ITVisions

<Debug>
 @Template

 @FormFields.Count
</Debug>

@if (!string.IsNullOrWhiteSpace(Template) && FormFields != null && FormFields.Any())
{
 @if (!string.IsNullOrEmpty(ValidationErrorMessage))
 {
  <div class="alert alert-danger" role="alert">
   @ValidationErrorMessage
  </div>
 }

 <EditForm Model="this" OnValidSubmit="OnSubmit">
  @{
   string currentHeadlineKey = null;
  }
  @foreach (var field in FormFields)
  {
   @if (field.Type == FieldType.Headline)
   {
    currentHeadlineKey = field.Key;
    var isCollapsed = CollapsedSections.Contains(field.Key);
    <h4 class="headline" @onclick="@(() => ToggleSection(field.Key))" style="cursor: pointer; user-select: none;">
     <span style="margin-right: 8px;"> <i class="bi bi-chevron-@(isCollapsed ? "down" : "right") me-2"></i></span>


     @field.Label
    </h4>
   }
   else
   {
    var shouldShow = string.IsNullOrEmpty(currentHeadlineKey) || !CollapsedSections.Contains(currentHeadlineKey);
    @if (shouldShow)
    {
     <div class="form-group">
      @if (!string.IsNullOrEmpty(field.Label))
      {
      <label class="fw-bold">
       @field.Label
       @if (field.Required)
       {
        <span style="margin-left:5px" title="Pflichtfeld" class="text-danger">*</span>
       }
      </label>
     }

     @if (field.Type == FieldType.RadioButtons)
    {
     <div class="d-flex gap-3">
      @foreach (var option in field.Options)
      {
       <div class="form-check">
        <input class="form-check-input" type="radio" name="@field.Key" id="@($"{field.Key}_{option}")" 
               value="@option" @onchange="@(e => { field.ValueString = option; NotifyValuesChanged(); })" 
               checked="@(field.ValueString == option)" />
        <label class="form-check-label" for="@($"{field.Key}_{option}")">@option</label>
       </div>
      }
     </div>
    }
    else if (field.Type == FieldType.CheckBox)
    {
     <div class="form-check">
      <input class="form-check-input" type="checkbox" id="@field.Key" 
             checked="@(!string.IsNullOrEmpty(field.ValueString))" 
             @onchange="@(e => { field.ValueString = ((bool)e.Value) ? field.Options[0] : ""; NotifyValuesChanged(); })" />
      <label class="form-check-label" for="@field.Key">@field.Options[0]</label>
     </div>
    }
    else if (field.Type == FieldType.Select)
    {
     <select class="form-select" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required">
      <option value="">Bitte wählen...</option>
      @foreach (var option in field.Options)
      {
       <option value="@option">@option</option>
      }
     </select>
    }
    else if (field.Type == FieldType.Multiselect)
    {
     <div class="d-flex flex-column gap-2">
      @foreach (var option in field.Options)
      {
       var isSelected = field.ValueString?.Split(',').Select(v => v.Trim()).Contains(option) ?? false;
       <div class="form-check">
        <input class="form-check-input" type="checkbox" id="@($"{field.Key}_{option}")" 
               checked="@isSelected"
               @onchange="@(e => HandleMultiselectChange(field, option, (bool)e.Value))" />
        <label class="form-check-label" for="@($"{field.Key}_{option}")">@option</label>
       </div>
      }
     </div>
    }
    else if (field.Type == FieldType.Rating)
    {
     <div class="d-flex gap-2 align-items-center">
      @foreach (var option in field.Options)
      {
       var isSelected = field.ValueString == option;
         <button type="button" class="btn btn-outline-secondary"
               style="min-width: 40px;"
               @onclick="@(() => { field.ValueString = option; NotifyValuesChanged(); })">
        @if (isSelected)
        {
         <span>★</span>
        }
        else
        {
         <span>☆</span>
        }
        @option
       </button>
      }
      @if (!string.IsNullOrEmpty(field.ValueString))
      {
       <button type="button" class="btn btn-sm btn-link" @onclick="@(() => { field.ValueString = ""; NotifyValuesChanged(); })">Zurücksetzen</button>
      }
     </div>
    }
    else if (field.Type == FieldType.Range)
    {
     <div class="d-flex gap-3 align-items-center">
      <input type="range" class="form-range" style="flex: 1;" 
             @bind="field.ValueString" 
             @bind:after="NotifyValuesChanged" 
             min="@field.Min" 
             max="@field.Max" 
             required="@field.Required" />
      <span class="badge bg-primary" style="min-width: 50px;">@field.ValueString</span>
     </div>
    }
    else if (field.Type == FieldType.Text)
    {
     <input type="text" class="form-control" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    else if (field.Type == FieldType.TextArea)
    {
     <textarea class="form-control" rows="4" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required"></textarea>
    }
    else if (field.Type == FieldType.Number)
    {
     <input type="number" class="form-control" 
            @bind="field.ValueString" 
            @bind:after="NotifyValuesChanged" 
            min="@field.Min" 
            max="@field.Max" 
            required="@field.Required" />
    }
    else if (field.Type == FieldType.Date)
    {
     <input type="date" class="form-control" @bind="field.ValueDateTime" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    else if (field.Type == FieldType.Time)
    {
       <input type="time" class="form-control" @bind="field.ValueDateTime" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    else if (field.Type == FieldType.Email)
    {
     <input type="email" class="form-control" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    else if (field.Type == FieldType.Password)
    {
     <input type="password" class="form-control" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    else if (field.Type == FieldType.Url)
    {
     <input type="url" class="form-control" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    else if (field.Type == FieldType.Phone)
    {
     <input type="tel" class="form-control" @bind="field.ValueString" @bind:after="NotifyValuesChanged" required="@field.Required" />
    }
    </div>
    }
   }
  }

  @if (ShowSubmitButton)
  {
   <ITVButton type="submit" class="btn btn-primary">@SubmitButtonText</ITVButton>
  }
 </EditForm>
}

@code {
 [Parameter]
 public string Template { get; set; }

 [Parameter]
 public EventCallback<FormFieldList> OnValuesChanged { get; set; }

  [Parameter]
 public EventCallback<FormFieldList> OnSubmited { get; set; }

 [Parameter]
 public bool ShowSubmitButton { get; set; } = true;

 [Parameter]
 public string SubmitButtonText { get; set; } = "Absenden";

 private FormFieldList FormFields { get; set; } = new();
 private string ValidationErrorMessage { get; set; } = "";
 private HashSet<string> CollapsedSections { get; set; } = new();

 protected override void OnParametersSet()
 {
  if (!string.IsNullOrEmpty(Template))
  {
   FormFields = TextTemplateFormParser.Parse(Template);
  }
 }

 private void ToggleSection(string sectionKey)
 {
  if (CollapsedSections.Contains(sectionKey))
  {
   CollapsedSections.Remove(sectionKey);
  }
  else
  {
   CollapsedSections.Add(sectionKey);
  }
 }

 private async void NotifyValuesChanged()
 {
  await OnValuesChanged.InvokeAsync(FormFields);
 }

 private void HandleMultiselectChange(FormField field, string option, bool isChecked)
 {
  var selectedValues = string.IsNullOrEmpty(field.ValueString)
   ? new List<string>()
   : field.ValueString.Split(',').Select(v => v.Trim()).ToList();

  if (isChecked && !selectedValues.Contains(option))
  {
   selectedValues.Add(option);
  }
  else if (!isChecked && selectedValues.Contains(option))
  {
   selectedValues.Remove(option);
  }

  field.ValueString = string.Join(", ", selectedValues);
  NotifyValuesChanged();
 }

 private async Task OnSubmit()
 {
  // Validierung der Pflichtfelder
  ValidationErrorMessage = "";
  var missingFields = new List<string>();

  foreach (var field in FormFields.Where(f => f.Required && f.Type != FieldType.Headline))
  {
   var isEmpty = string.IsNullOrWhiteSpace(field.ValueString);

   if (isEmpty)
   {
    missingFields.Add(field.Label);
   }
  }

  if (missingFields.Any())
  {
   ValidationErrorMessage = $"Bitte füllen Sie folgende Pflichtfelder aus: {string.Join(", ", missingFields)}";
   StateHasChanged();
   return;
  }

  await OnValuesChanged.InvokeAsync(FormFields);
  await OnSubmited.InvokeAsync(FormFields);
 }

 public FormFieldList GetFormFields()
 {
  return FormFields;
 }

}